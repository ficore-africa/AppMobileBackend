<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Activation Dashboard - FiCore Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #F5F1E8;
            color: #2C1810;
            line-height: 1.6;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #8B6F47;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #8B6F47;
            color: white;
        }

        .btn-primary:hover {
            background: #6F5639;
        }

        .btn-secondary {
            background: white;
            color: #8B6F47;
            border: 1px solid #8B6F47;
        }

        .btn-secondary:hover {
            background: #F5F1E8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .timeframe-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 8px;
            width: fit-content;
        }

        .timeframe-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #8B6F47;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .timeframe-btn.active {
            background: #8B6F47;
            color: white;
        }

        .timeframe-btn:hover:not(.active) {
            background: #F5F1E8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #6B7280;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2C1810;
            margin-bottom: 0.25rem;
        }

        .stat-trend {
            font-size: 0.85rem;
            color: #10B981;
            font-weight: 500;
        }

        .stat-trend.negative {
            color: #EF4444;
        }

        .stat-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .stat-status.success {
            background: #D1FAE5;
            color: #065F46;
        }

        .stat-status.warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .chart-container h2 {
            font-size: 1.25rem;
            color: #2C1810;
            margin-bottom: 1.5rem;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F5F1E8;
            border-radius: 8px;
            color: #6B7280;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-box {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .metric-box h3 {
            font-size: 1rem;
            color: #2C1810;
            margin-bottom: 1rem;
        }

        .metric-detail {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #F5F1E8;
        }

        .metric-detail:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #6B7280;
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: 600;
            color: #2C1810;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: #6B7280;
        }

        .error {
            background: #FEE2E2;
            color: #991B1B;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .pie-chart {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .pie-visual {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            position: relative;
        }

        .pie-legend {
            flex: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-label {
            flex: 1;
            color: #6B7280;
            font-size: 0.9rem;
        }

        .legend-value {
            font-weight: 600;
            color: #2C1810;
        }
    </style>
    <link rel="stylesheet" href="backend_switcher.css">
</head>
<body>
    <div class="header">
        <h1>üìä User Activation Dashboard</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
            <a href="analytics_dashboard.html" class="btn btn-secondary">‚Üê Back to Home</a>
        </div>
    </div>

    <div class="container">
        <div class="timeframe-selector">
            <button class="timeframe-btn" data-timeframe="7" onclick="selectTimeframe('7')">7 Days</button>
            <button class="timeframe-btn active" data-timeframe="30" onclick="selectTimeframe('30')">30 Days</button>
            <button class="timeframe-btn" data-timeframe="90" onclick="selectTimeframe('90')">90 Days</button>
            <button class="timeframe-btn" data-timeframe="all" onclick="selectTimeframe('all')">All Time</button>
        </div>

        <div id="loading" class="loading">
            <p>Loading activation metrics...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <!-- Key Metrics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Signups</h3>
                    <div class="stat-value" id="totalSignups">-</div>
                    <div class="stat-trend" id="signupsTrend"></div>
                </div>

                <div class="stat-card">
                    <h3>Activated Users</h3>
                    <div class="stat-value" id="activatedUsers">-</div>
                    <div class="stat-trend" id="activatedTrend"></div>
                </div>

                <div class="stat-card">
                    <h3>Activation Rate</h3>
                    <div class="stat-value" id="activationRate">-</div>
                    <span class="stat-status" id="activationStatus">-</span>
                </div>

                <div class="stat-card">
                    <h3>Avg Time to First Entry</h3>
                    <div class="stat-value" id="avgTime">-</div>
                    <div class="stat-trend">Median: <span id="medianTime">-</span></div>
                </div>
            </div>

            <!-- Time Distribution -->
            <div class="metrics-row">
                <div class="metric-box">
                    <h3>‚è±Ô∏è Time to First Entry Distribution</h3>
                    <div class="metric-detail">
                        <span class="metric-label">0-5 minutes</span>
                        <span class="metric-value" id="dist0-5">-</span>
                    </div>
                    <div class="metric-detail">
                        <span class="metric-label">5-15 minutes</span>
                        <span class="metric-value" id="dist5-15">-</span>
                    </div>
                    <div class="metric-detail">
                        <span class="metric-label">15-60 minutes</span>
                        <span class="metric-value" id="dist15-60">-</span>
                    </div>
                    <div class="metric-detail">
                        <span class="metric-label">60+ minutes</span>
                        <span class="metric-value" id="dist60plus">-</span>
                    </div>
                </div>

                <div class="metric-box">
                    <h3>üìù Entry Type Split</h3>
                    <div class="pie-chart">
                        <div class="pie-visual" id="pieChart"></div>
                        <div class="pie-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #10B981;"></div>
                                <span class="legend-label">Income First</span>
                                <span class="legend-value" id="incomePercent">-</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #F59E0B;"></div>
                                <span class="legend-label">Expense First</span>
                                <span class="legend-value" id="expensePercent">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Entry Rate -->
            <div class="metric-box">
                <h3>üîÑ Second Entry Rate (Retention)</h3>
                <div class="metric-detail">
                    <span class="metric-label">Users with 2+ entries</span>
                    <span class="metric-value" id="secondEntryTotal">-</span>
                </div>
                <div class="metric-detail">
                    <span class="metric-label">Second entry rate</span>
                    <span class="metric-value" id="secondEntryRate">-</span>
                </div>
                <div class="metric-detail">
                    <span class="metric-label">Within 24 hours</span>
                    <span class="metric-value" id="secondEntry24h">-</span>
                </div>
            </div>

            <!-- PHASE 4C: Nudge Performance Table -->
            <div class="metric-box" style="margin-top: 2rem;">
                <h3>üéØ Nudge Performance</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                    <thead>
                        <tr style="background: #F5F1E8; text-align: left;">
                            <th style="padding: 12px; font-size: 0.85rem; color: #6B7280;">Nudge Type</th>
                            <th style="padding: 12px; font-size: 0.85rem; color: #6B7280;">Shown</th>
                            <th style="padding: 12px; font-size: 0.85rem; color: #6B7280;">Dismissed</th>
                            <th style="padding: 12px; font-size: 0.85rem; color: #6B7280;">Converted</th>
                            <th style="padding: 12px; font-size: 0.85rem; color: #6B7280;">Rate</th>
                            <th style="padding: 12px; font-size: 0.85rem; color: #6B7280;">Avg Time</th>
                        </tr>
                    </thead>
                    <tbody id="nudgePerformanceTable">
                        <tr><td colspan="6" style="text-align: center; padding: 20px; color: #6B7280;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- PHASE 4C: Activation Funnel -->
            <div class="metric-box" style="margin-top: 2rem;">
                <h3>üìä Activation Funnel</h3>
                <div id="funnelChart" style="margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 20px; color: #6B7280;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script src="backend_switcher.js"></script>
    <script>
        let currentTimeframe = '30';

        function selectTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update button states
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.timeframe === timeframe) {
                    btn.classList.add('active');
                }
            });
            
            loadActivationStats();
        }

        function refreshData() {
            loadActivationStats();
            loadNudgePerformance();
            loadFunnelData();
        }

        async function loadActivationStats() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';
            
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    window.location.href = 'admin_login.html';
                    return;
                }
                
                const response = await fetch(`https://mobilebackend.ficoreafrica.com/admin/activation/stats?timeframe=${currentTimeframe}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load activation stats');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayStats(result.data);
                    loading.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    throw new Error(result.message || 'Failed to load stats');
                }
                
            } catch (err) {
                console.error('Error loading activation stats:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Failed to load activation metrics. Please try again.';
            }
        }

        function displayStats(data) {
            // Key metrics
            document.getElementById('totalSignups').textContent = data.signups.total.toLocaleString();
            document.getElementById('activatedUsers').textContent = data.firstEntries.total.toLocaleString();
            document.getElementById('activationRate').textContent = data.activationRate.percentage + '%';
            
            // Activation status
            const statusEl = document.getElementById('activationStatus');
            if (data.activationRate.status === 'on_target') {
                statusEl.textContent = '‚úÖ On Target';
                statusEl.className = 'stat-status success';
            } else {
                statusEl.textContent = '‚ö†Ô∏è Below Target';
                statusEl.className = 'stat-status warning';
            }
            
            // Time metrics
            document.getElementById('avgTime').textContent = data.avgTimeToFirstEntry.minutes.toFixed(1) + ' min';
            document.getElementById('medianTime').textContent = data.avgTimeToFirstEntry.median.toFixed(1) + ' min';
            
            // Distribution
            document.getElementById('dist0-5').textContent = data.avgTimeToFirstEntry.distribution['0-5min'];
            document.getElementById('dist5-15').textContent = data.avgTimeToFirstEntry.distribution['5-15min'];
            document.getElementById('dist15-60').textContent = data.avgTimeToFirstEntry.distribution['15-60min'];
            document.getElementById('dist60plus').textContent = data.avgTimeToFirstEntry.distribution['60min+'];
            
            // Entry type split
            document.getElementById('incomePercent').textContent = data.entryTypeSplit.incomePercentage.toFixed(1) + '%';
            document.getElementById('expensePercent').textContent = data.entryTypeSplit.expensePercentage.toFixed(1) + '%';
            
            // Pie chart
            const pieChart = document.getElementById('pieChart');
            const incomePercent = data.entryTypeSplit.incomePercentage;
            pieChart.style.background = `conic-gradient(
                #10B981 0% ${incomePercent}%,
                #F59E0B ${incomePercent}% 100%
            )`;
            
            // Second entry rate
            document.getElementById('secondEntryTotal').textContent = data.secondEntryRate.total.toLocaleString();
            document.getElementById('secondEntryRate').textContent = data.secondEntryRate.percentage.toFixed(1) + '%';
            document.getElementById('secondEntry24h').textContent = data.secondEntryRate.within24h.toLocaleString();
        }

        // PHASE 4C: Load nudge performance data
        async function loadNudgePerformance() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;
                
                const response = await fetch(`https://mobilebackend.ficoreafrica.com/admin/activation/nudge-performance?timeframe=${currentTimeframe}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load nudge performance');
                
                const result = await response.json();
                
                if (result.success) {
                    displayNudgePerformance(result.data.nudges);
                }
            } catch (err) {
                console.error('Error loading nudge performance:', err);
                document.getElementById('nudgePerformanceTable').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #EF4444;">Failed to load nudge performance</td></tr>';
            }
        }

        function displayNudgePerformance(nudges) {
            const tbody = document.getElementById('nudgePerformanceTable');
            
            if (!nudges || nudges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #6B7280;">No nudge data available yet</td></tr>';
                return;
            }

            const nudgeLabels = {
                'noEntryYet': 'No Entry Yet',
                'firstEntryDone': 'First Entry Done',
                'earlyStreak': 'Early Streak',
                'sevenDayStreak': '7-Day Streak'
            };

            tbody.innerHTML = nudges.map(nudge => {
                const rateColor = nudge.conversionRate >= 80 ? '#10B981' : 
                                 nudge.conversionRate >= 60 ? '#F59E0B' : '#EF4444';
                
                return `
                    <tr style="border-bottom: 1px solid #F5F1E8;">
                        <td style="padding: 12px; font-weight: 600;">${nudgeLabels[nudge.type] || nudge.type}</td>
                        <td style="padding: 12px;">${nudge.shown}</td>
                        <td style="padding: 12px;">${nudge.dismissed}</td>
                        <td style="padding: 12px;">${nudge.converted}</td>
                        <td style="padding: 12px; color: ${rateColor}; font-weight: 600;">${nudge.conversionRate}%</td>
                        <td style="padding: 12px;">${nudge.avgTimeToConversion.toFixed(1)} min</td>
                    </tr>
                `;
            }).join('');
        }

        // PHASE 4C: Load funnel data
        async function loadFunnelData() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;
                
                const response = await fetch(`https://mobilebackend.ficoreafrica.com/admin/activation/funnel?timeframe=${currentTimeframe}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load funnel data');
                
                const result = await response.json();
                
                if (result.success) {
                    displayFunnel(result.data.funnel, result.data.dropOff);
                }
            } catch (err) {
                console.error('Error loading funnel data:', err);
                document.getElementById('funnelChart').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #EF4444;">Failed to load funnel data</div>';
            }
        }

        function displayFunnel(funnel, dropOff) {
            const container = document.getElementById('funnelChart');
            
            if (!funnel || funnel.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6B7280;">No funnel data available yet</div>';
                return;
            }

            const stateLabels = {
                'S0': 'Signup',
                'S1': 'First Entry',
                'S2': 'Early Streak',
                'S3': '7-Day Streak'
            };

            const colors = ['#1E3A8A', '#3B82F6', '#60A5FA', '#93C5FD'];

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            
            funnel.forEach((stage, index) => {
                const barWidth = stage.percentage;
                const color = colors[index] || '#6B7280';
                
                html += `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="min-width: 120px; font-weight: 600; color: #2C1810;">
                            ${stateLabels[stage.state] || stage.state}
                        </div>
                        <div style="flex: 1; background: #F5F1E8; border-radius: 8px; height: 40px; position: relative; overflow: hidden;">
                            <div style="background: ${color}; height: 100%; width: ${barWidth}%; transition: width 0.3s; display: flex; align-items: center; padding: 0 1rem; color: white; font-weight: 600;">
                                ${stage.count.toLocaleString()} (${stage.percentage}%)
                            </div>
                        </div>
                    </div>
                `;

                // Show drop-off between stages
                if (index < funnel.length - 1) {
                    const nextStage = funnel[index + 1];
                    const dropOffKey = `${stage.state}_to_${nextStage.state}`;
                    const dropOffRate = dropOff[dropOffKey] || 0;
                    
                    if (dropOffRate > 0) {
                        html += `
                            <div style="margin-left: 140px; font-size: 0.85rem; color: #EF4444;">
                                ‚Üì ${dropOffRate}% drop-off
                            </div>
                        `;
                    }
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadActivationStats();
            loadNudgePerformance();
            loadFunnelData();
        });
    </script>
</body>
</html>
