<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if status == 'success' %}Payment Successful{% else %}Payment Processing{% endif %}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #5568d3;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            background: #fef3c7;
            color: #92400e;
            margin-top: 0.5rem;
        }
        .details {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        .details-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .details-label {
            color: #6b7280;
        }
        .details-value {
            font-weight: 600;
            color: #111827;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="content">
            {% if status == 'success' %}
                <div class="icon success">✓</div>
                <h1 class="success">Payment Successful!</h1>
                {% if test_mode %}
                    <span class="badge">TEST MODE</span>
                {% endif %}
                <p>{{ message or 'Your transaction has been completed successfully.' }}</p>
                {% if amount %}
                    <div class="details">
                        <div class="details-row">
                            <span class="details-label">Amount:</span>
                            <span class="details-value">{{ amount }}</span>
                        </div>
                        {% if reference %}
                        <div class="details-row">
                            <span class="details-label">Reference:</span>
                            <span class="details-value" style="font-size: 0.75rem;">{{ reference }}</span>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
                <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 1.5rem;">
                    Redirecting to the app...<br>
                    If the app doesn't open automatically, please open it manually.
                </p>
            {% elif status == 'failed' %}
                <div class="icon error">✗</div>
                <h1 class="error">Payment Failed</h1>
                <p>{{ message or 'We couldn\'t process your payment.' }}</p>
                {% if error %}
                    <div class="details">
                        <div class="details-row">
                            <span class="details-label">Error:</span>
                            <span class="details-value">{{ error.replace('_', ' ').title() }}</span>
                        </div>
                        {% if reference %}
                        <div class="details-row">
                            <span class="details-label">Reference:</span>
                            <span class="details-value" style="font-size: 0.75rem;">{{ reference }}</span>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
                <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 1.5rem;">
                    Please try again or contact support if the issue persists.
                </p>
            {% elif status == 'completed' %}
                <div class="icon warning">⚠</div>
                <h1 class="warning">Already Processed</h1>
                <p>{{ message or 'This transaction has already been completed.' }}</p>
                {% if reference %}
                    <div class="details">
                        <div class="details-row">
                            <span class="details-label">Reference:</span>
                            <span class="details-value" style="font-size: 0.75rem;">{{ reference }}</span>
                        </div>
                    </div>
                {% endif %}
                <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 1.5rem;">
                    Redirecting to the app...
                </p>
            {% else %}
                <div class="spinner"></div>
                <h1>Processing Payment...</h1>
                <p>Please wait while we verify your payment.</p>
            {% endif %}
        </div>
    </div>

    <script>
        // Auto-redirect to app after showing success/error message
        {% if status in ['success', 'completed'] %}
            // Try deep link first
            setTimeout(() => {
                // Try to open the app via deep link
                window.location.href = 'ficoreafrica://payment-callback?status={{ status }}&reference={{ reference or "" }}';
                
                // Fallback: Show manual instruction after 3 seconds
                setTimeout(() => {
                    const content = document.getElementById('content');
                    const instruction = document.createElement('p');
                    instruction.style.cssText = 'font-size: 0.875rem; color: #ef4444; margin-top: 1rem; font-weight: 600;';
                    instruction.textContent = 'Please open the FiCore app manually to see your updated balance.';
                    content.appendChild(instruction);
                }, 3000);
            }, 2000);
        {% elif status == 'failed' %}
            // For failed payments, try to return to app after 5 seconds
            setTimeout(() => {
                window.location.href = 'ficoreafrica://payment-callback?status=failed&error={{ error or "unknown" }}';
            }, 5000);
        {% endif %}
    </script>
</body>
</html>
